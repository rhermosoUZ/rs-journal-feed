<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recommender Systems — Research Briefing (JCR core)</title>

  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --muted:#a9b3d1; --text:#eef2ff; --chip:#1a2550;
      --accent:#7aa2ff; --border:rgba(255,255,255,.08); --border2:rgba(255,255,255,.12);
      --ok:rgba(60,255,170,.10); --warn:rgba(255,210,77,.10);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--text); }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{ max-width:1100px; margin:0 auto; padding:24px 16px 10px; }
    h1{ margin:0 0 6px; font-size:24px; font-weight:800; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; line-height:1.4; }
    .wrap{ max-width:1100px; margin:0 auto; padding:0 16px 40px; }

    .controls{ display:grid; grid-template-columns: 1.2fr .9fr .9fr .8fr; gap:10px; margin:14px 0 10px; }
    @media (max-width: 900px){ .controls{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 520px){ .controls{ grid-template-columns: 1fr; } }

    .control{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{
      width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.15); color:var(--text); padding:9px 10px; font-size:13px; outline:none;
    }
    input::placeholder{ color: rgba(238,242,255,.45); }

    .toggles{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0; }
    .toggle{ display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border);
      border-radius:999px; padding:8px 10px; }
    .toggle input{ width:auto; }
    .btn{ cursor:pointer; border:1px solid var(--border2); background:rgba(122,162,255,.10);
      color:var(--text); padding:8px 10px; border-radius:10px; font-size:13px; }
    .btn:hover{ background:rgba(122,162,255,.16); }

    .meta{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin:10px 0 14px; color:var(--muted); font-size:13px; }
    .status{ margin:10px 0 0; color:var(--muted); font-size:12.5px; }
    .err{ color:#ffb4b4; }

    .section{ margin:14px 0 8px; font-size:14px; font-weight:800; letter-spacing:.2px; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px 12px 10px; }
    .title{ font-size:15px; font-weight:800; margin:0 0 6px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px 12px; color:var(--muted); font-size:12.5px; margin-bottom:8px; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .chip{ font-size:11.5px; color:var(--text); background:var(--chip); border:1px solid var(--border);
      padding:4px 8px; border-radius:999px; }
    .chip.oa{ background:var(--ok); border-color:rgba(60,255,170,.25); }
    .chip.cites{ background:var(--warn); border-color:rgba(255,210,77,.25); }
    .chip.topic{ cursor:pointer; }
    .chip.topic:hover{ border-color:rgba(255,255,255,.20); }
    details{ margin-top:8px; }
    summary{ cursor:pointer; color:var(--accent); font-size:12.5px; }
    .abs{ color:var(--text); opacity:.92; font-size:13px; line-height:1.45; margin-top:8px; }

    .foot{ margin-top:18px; color:var(--muted); font-size:12px; line-height:1.35; }
    code{ background:rgba(255,255,255,.06); padding:2px 6px; border-radius:8px; }
  </style>
</head>

<body>
<header>
  <h1>Recommender Systems — Research Briefing</h1>
  <div class="sub">
    Snapshot de los últimos <span id="daysLabel">90</span> días en revistas núcleo (JCR core): ESWA, Information Sciences, DSS, KBS, TKDE, CSUR, IP&amp;M, EAAI, IEEE Access.
    Fuente: OpenAlex (citas + OA + metadatos).
  </div>

  <div class="controls">
    <div class="control">
      <label for="q">Search (título/abstract)</label>
      <input id="q" placeholder='Ej: "graph neural" | "sequential" | "fairness" | "explainable"' />
    </div>

    <div class="control">
      <label for="journal">Filter by Journal</label>
      <select id="journal"></select>
    </div>

    <div class="control">
      <label for="topic">Filter by Topic</label>
      <select id="topic"></select>
    </div>

    <div class="control">
      <label for="sort">Sort by</label>
      <select id="sort">
        <option value="date_desc" selected>Date (Newest First)</option>
        <option value="date_asc">Date (Oldest First)</option>
        <option value="journal_asc">Journal</option>
        <option value="title_asc">Title (A–Z)</option>
        <option value="cites_desc">Citations (High → Low)</option>
      </select>
    </div>
  </div>

  <div class="controls">
    <div class="control">
      <label for="days">Ventana temporal</label>
      <select id="days">
        <option value="30">30 días</option>
        <option value="60">60 días</option>
        <option value="90" selected>90 días</option>
        <option value="180">180 días</option>
        <option value="365">365 días</option>
      </select>
    </div>

    <div class="control">
      <label for="mailto">OpenAlex mailto (recomendado)</label>
      <input id="mailto" placeholder="tu_email@unizar.es" />
    </div>

    <div class="control">
      <label>Acciones</label>
      <button class="btn" id="reload">Actualizar (OpenAlex)</button>
    </div>

    <div class="control">
      <label>Opciones</label>
      <div class="toggles" style="margin:0">
        <label class="toggle"><input type="checkbox" id="oaOnly" /> Open Access Only</label>
        <label class="toggle"><input type="checkbox" id="showAbs" /> Show Abstracts</label>
        <label class="toggle"><input type="checkbox" id="rsOnly" checked /> Solo RecSys</label>
      </div>
    </div>
  </div>

  <div class="status" id="status"></div>
</header>

<main class="wrap">
  <div class="meta">
    <div id="metaLeft">Cargando…</div>
    <div id="metaRight"></div>
  </div>

  <div id="sections"></div>

  <div class="foot">
    <div><strong>Cómo funciona:</strong> se consultan works tipo <code>journal-article</code> filtrando por revista (source) y por rango de fechas. OpenAlex: filtros, búsqueda, paginación por cursor. </div>
    <div>“Citations” viene de <code>cited_by_count</code> y “Open Access” de <code>open_access.is_oa</code> (OpenAlex). </div>
    <div style="margin-top:6px; opacity:.9">
      Nota: la asignación de <em>Topics</em> aquí es heurística (keywords) para replicar la UX del briefing.
    </div>
  </div>
</main>

<script>
  // ============================
  // Journals (ISSN) — core list
  // ============================
  const JOURNALS = [
    { name: "All Journals", issn: null },
    { name: "Expert Systems with Applications", issn: "0957-4174" },
    { name: "Information Sciences", issn: "0020-0255" },
    { name: "Decision Support Systems", issn: "0167-9236" },
    { name: "Knowledge-Based Systems", issn: "0950-7051" },
    { name: "IEEE TKDE", issn: "1041-4347" },
    { name: "ACM Computing Surveys (CSUR)", issn: "0360-0300" },
    { name: "Information Processing & Management", issn: "0306-4573" },
    { name: "Engineering Applications of Artificial Intelligence", issn: "0952-1976" },
    { name: "IEEE Access", issn: "2169-3536" },
  ];

  // ============================
  // Topic rules (heurístico)
  // ============================
  const TOPIC_RULES = [
    { topic: "Sequential / Session-based", rx: /(sequential|session[-\s]?based|next[-\s]?item|sasrec|bert4rec|gru4rec|transformer|attention)/i },
    { topic: "Graph / Knowledge Graph", rx: /(graph neural|gnn|lightgcn|ngcf|graph[-\s]?based|knowledge graph|kgat|ripplenet|heterogeneous|relational)/i },
    { topic: "Deep Learning / Neural", rx: /(deep|neural|dnn|cnn|rnn|lstm|autoencoder|vae|diffusion)/i },
    { topic: "LLM / Conversational", rx: /(llm|large language model|chatbot|conversational|dialog(ue)?|prompt|retrieval-augmented|rag)/i },
    { topic: "Explainability (XAI)", rx: /(explain|explanation|interpretable|transparen|xai|counterfactual|rationale)/i },
    { topic: "Fairness / Bias", rx: /(fair|bias|disparit|equity|protected attribute|debias|adverse impact)/i },
    { topic: "Privacy / Security", rx: /(privacy|private|differential privacy|federated|secure|encryption|attack|poison)/i },
    { topic: "Evaluation / Ranking", rx: /(evaluation|offline|online|a\/b|metric|ndcg|map|mrr|hit@|recall@|precision@|ranking|calibration)/i },
    { topic: "Context-Aware / Mobility", rx: /(context[-\s]?aware|spatiotemporal|location|poi|mobility|trajectory|tourism|route)/i },
    { topic: "Cold-start / Hybrid", rx: /(cold[-\s]?start|hybrid|content[-\s]?based|feature[-\s]?based|side information)/i },
  ];

  // Core RS filter (suave) + default search
  const CORE_RS_RX = /(recommender|recommendation|collaborative\s*filtering|content[-\s]*based|hybrid\s*recommender|implicit feedback|top[-\s]?n|ranking model)/i;
  const DEFAULT_SEARCH = "recommender system";

  // ============================
  // Helpers
  // ============================
  const el = (id) => document.getElementById(id);
  const state = { works: [], lastUpdated: null, sourceIdCache: new Map() };

  function isoDate(d){
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function setStatus(msg, isErr=false){
    el("status").textContent = msg;
    el("status").className = "status" + (isErr ? " err" : "");
  }

  function authorsToString(authorships){
    if(!authorships?.length) return "Autores no disponibles";
    const names = authorships.map(a=>a?.author?.display_name).filter(Boolean);
    return names.slice(0,8).join(", ") + (names.length>8 ? " et al." : "");
  }

  function bestUrl(work){
    if(work?.doi) return work.doi;
    if(work?.id) return work.id;
    return null;
  }

  function formatJournal(work){
    return work?.primary_location?.source?.display_name
      || work?.host_venue?.display_name
      || "Journal no disponible";
  }

  function pubDate(work){
    return work?.publication_date || null;
  }

  function isOA(work){
    return Boolean(work?.open_access?.is_oa);
  }

  // ---- OpenAlex abstract: abstract_inverted_index -> text
  function invertedIndexToText(inv){
    if(!inv) return "";
    let maxPos = 0;
    for (const w in inv) for (const p of inv[w]) if (p > maxPos) maxPos = p;
    const arr = new Array(maxPos + 1).fill("");
    for (const w in inv) for (const p of inv[w]) arr[p] = w;
    return arr.join(" ").replace(/\s+/g," ").trim();
  }

  function getAbstractText(work){
    return invertedIndexToText(work?.abstract_inverted_index);
  }

  function getTextHaystack(w){
    const title = w?.title || "";
    const abs = getAbstractText(w);
    const concepts = (w?.concepts || []).map(c=>c?.display_name).filter(Boolean).join(" ");
    return `${title} ${abs} ${concepts}`.trim();
  }

  function classifyTopics(w){
    const hay = getTextHaystack(w);
    const topics = [];
    for(const rule of TOPIC_RULES){
      if(rule.rx.test(hay)) topics.push(rule.topic);
    }
    if(topics.length===0) topics.push("General RS");
    return topics;
  }

  function daysAgo(dateStr){
    if(!dateStr) return Infinity;
    const ms = Date.now() - new Date(dateStr).getTime();
    return ms / (1000*60*60*24);
  }

  function bucketLabel(w){
    const d = daysAgo(pubDate(w));
    if(d <= 7) return "This Week";
    if(d <= 14) return "Last 2 Weeks";
    if(d <= 30) return "Last Month";
    return "Older";
  }

  // ============================
  // OpenAlex: resolve source id from ISSN
  // ============================
  async function resolveSourceIdFromIssn(issn){
    if(state.sourceIdCache.has(issn)) return state.sourceIdCache.get(issn);

    const cacheKey = `openalex_source_id_${issn}`;
    const cached = localStorage.getItem(cacheKey);
    if(cached){
      state.sourceIdCache.set(issn, cached);
      return cached; // Sxxxx
    }

    const url = `https://api.openalex.org/sources/issn:${encodeURIComponent(issn)}?select=id,display_name`;
    const r = await fetch(url);
    if(!r.ok) throw new Error(`No puedo resolver source id para ISSN ${issn} (HTTP ${r.status})`);
    const j = await r.json();
    const id = j?.id;
    if(!id) throw new Error(`Respuesta sin id al resolver ISSN ${issn}`);
    const shortId = id.split("/").pop(); // "S123..."
    localStorage.setItem(cacheKey, shortId);
    state.sourceIdCache.set(issn, shortId);
    return shortId;
  }

  // ============================
  // OpenAlex fetch by source id + date + search
  // ============================
  async function fetchWorksForSourceId(sourceId, fromDate, toDate, perPage=200, mailto="", searchTerm=""){
    const base = "https://api.openalex.org/works";
    let cursor = "*";
    let out = [];
    let guard = 0;

    while(guard < 6){
      const url =
        `${base}?filter=` +
        `primary_location.source.id:${encodeURIComponent(sourceId)},` +
        `from_publication_date:${fromDate},to_publication_date:${toDate},` +
        `type:journal-article` +
        `&per-page=${perPage}` +
        `&cursor=${encodeURIComponent(cursor)}` +
        (searchTerm ? `&search=${encodeURIComponent(searchTerm)}` : "") +
        (mailto ? `&mailto=${encodeURIComponent(mailto)}` : "");

      const r = await fetch(url);
      if(!r.ok) throw new Error(`OpenAlex error ${r.status} for source ${sourceId}`);
      const j = await r.json();

      out = out.concat(j.results || []);
      cursor = j?.meta?.next_cursor;
      guard += 1;

      if(!cursor) break;
      if((j.results || []).length === 0) break;
    }
    return out;
  }

  // ============================
  // Load + normalize
  // ============================
  async function loadData(){
    const days = parseInt(el("days").value, 10);
    el("daysLabel").textContent = String(days);

    const to = new Date();
    const from = new Date();
    from.setDate(to.getDate() - days);
    const fromDate = isoDate(from);
    const toDate = isoDate(to);

    const selectedJournal = el("journal").value;
    const mailto = (el("mailto").value || "").trim();
    const rsOnly = el("rsOnly").checked;

    const journalsToQuery = (selectedJournal && selectedJournal !== "__ALL__")
      ? JOURNALS.filter(j => j.issn === selectedJournal)
      : JOURNALS.filter(j => j.issn);

    // Search strategy:
    // - If user typed q => use it
    // - else if rsOnly => default search "recommender system"
    // - else => empty (will return a lot; not recommended)
    const q = (el("q").value || "").trim();
    const searchTerm = q ? q : (rsOnly ? DEFAULT_SEARCH : "");

    setStatus("Cargando desde OpenAlex…");
    el("sections").innerHTML = "";
    el("metaLeft").textContent = "Cargando…";
    el("metaRight").textContent = "";

    const results = [];
    const seen = new Set();

    for(const j of journalsToQuery){
      setStatus(`Consultando: ${j.name}…`);

      const sourceId = await resolveSourceIdFromIssn(j.issn);
      const works = await fetchWorksForSourceId(sourceId, fromDate, toDate, 200, mailto, searchTerm);

      for(const w of works){
        const key = (w.doi || w.id || JSON.stringify([w.title, w.publication_date]));
        if(seen.has(key)) continue;
        seen.add(key);

        // If rsOnly, keep a soft RS filter (now with abstract reconstructed)
        if(rsOnly){
          const hay = getTextHaystack(w);
          if(!CORE_RS_RX.test(hay)) continue;
        }

        w.__journal_issn = j.issn;
        w.__journal_name = j.name;
        w.__topics = classifyTopics(w);
        w.__bucket = bucketLabel(w);
        results.push(w);
      }
    }

    state.works = results;
    state.lastUpdated = new Date();

    setStatus(`OK — ${results.length} artículos. Updated: ${state.lastUpdated.toLocaleString()}`);
    buildTopicDropdown();
    render();
  }

  // ============================
  // Filters & sorting
  // ============================
  function applyFilters(works){
    const q = (el("q").value || "").trim();
    const oaOnly = el("oaOnly").checked;
    const topicSel = el("topic").value;

    const qRx = q ? new RegExp(q, "i") : null;

    return works.filter(w=>{
      if(oaOnly && !isOA(w)) return false;

      if(topicSel && topicSel !== "__ALL__"){
        if(!(w.__topics || []).includes(topicSel)) return false;
      }

      if(qRx){
        const hay = getTextHaystack(w);
        if(!qRx.test(hay)) return false;
      }
      return true;
    });
  }

  function applySort(works){
    const mode = el("sort").value;
    const arr = works.slice();

    const dateVal = (w)=>{
      const d = pubDate(w);
      return d ? new Date(d).getTime() : 0;
    };

    if(mode==="date_desc") arr.sort((a,b)=> dateVal(b)-dateVal(a));
    if(mode==="date_asc") arr.sort((a,b)=> dateVal(a)-dateVal(b));
    if(mode==="journal_asc") arr.sort((a,b)=> (a.__journal_name||"").localeCompare((b.__journal_name||""), "es"));
    if(mode==="title_asc") arr.sort((a,b)=> (a.title||"").localeCompare((b.title||""), "es"));
    if(mode==="cites_desc") arr.sort((a,b)=> (b.cited_by_count||0)-(a.cited_by_count||0));

    return arr;
  }

  // ============================
  // Topic dropdown with counts
  // ============================
  function buildTopicDropdown(){
    const sel = el("topic");
    const counts = new Map();

    for(const w of state.works){
      for(const t of (w.__topics||["General RS"])){
        counts.set(t, (counts.get(t)||0)+1);
      }
    }

    const topics = Array.from(counts.entries())
      .sort((a,b)=> b[1]-a[1])
      .map(([t,c]) => ({t,c}));

    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "__ALL__";
    optAll.textContent = "All Topics";
    sel.appendChild(optAll);

    for(const {t,c} of topics){
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = `${t} (${c})`;
      sel.appendChild(opt);
    }

    if(!sel.value) sel.value = "__ALL__";
  }

  // ============================
  // Render sections
  // ============================
  function render(){
    const showAbs = el("showAbs").checked;

    const filtered = applyFilters(state.works);
    const sorted = applySort(filtered);

    el("metaLeft").textContent = `Showing ${sorted.length} articles`;
    const days = el("days").value;
    const jSel = el("journal").value === "__ALL__" ? "All Journals" : (JOURNALS.find(j=>j.issn===el("journal").value)?.name || "Journal");
    const tSel = el("topic").value === "__ALL__" ? "All Topics" : el("topic").value;
    el("metaRight").textContent = `${jSel} • ${tSel} • last ${days} days`;

    const byBucket = new Map([["This Week",[]],["Last 2 Weeks",[]],["Last Month",[]],["Older",[]]]);
    for(const w of sorted){
      const b = w.__bucket || "Older";
      if(!byBucket.has(b)) byBucket.set(b, []);
      byBucket.get(b).push(w);
    }

    const sections = el("sections");
    sections.innerHTML = "";

    for(const [bucket, items] of byBucket.entries()){
      if(items.length === 0) continue;

      const h = document.createElement("div");
      h.className = "section";
      h.textContent = bucket;
      sections.appendChild(h);

      const list = document.createElement("div");
      list.className = "list";

      for(const w of items){
        const card = document.createElement("div");
        card.className = "card";

        const url = bestUrl(w);
        const title = w?.title || "Título no disponible";
        const journal = formatJournal(w);
        const date = pubDate(w) || "Fecha no disponible";
        const authors = authorsToString(w?.authorships);
        const cites = w?.cited_by_count ?? 0;
        const oa = isOA(w);
        const abs = getAbstractText(w);
        const topics = (w.__topics || ["General RS"]).slice(0, 6);

        const topicChips = topics.map(t => `<span class="chip topic" data-topic="${t}">${t}</span>`).join("");

        card.innerHTML = `
          <div class="title">${url ? `<a href="${url}" target="_blank" rel="noopener">${title}</a>` : title}</div>
          <div class="row">
            <span><strong>${journal}</strong></span>
            <span>${authors}</span>
            <span>${date}</span>
          </div>
          <div class="chips">
            ${oa ? `<span class="chip oa">Open Access</span>` : ``}
            <span class="chip cites">Citations: ${cites}</span>
            ${w?.doi ? `<span class="chip">DOI</span>` : ``}
          </div>
          <div class="chips" style="margin-top:8px">${topicChips}</div>
          ${abs ? `
            <details ${showAbs ? "open" : ""}>
              <summary>Abstract</summary>
              <div class="abs">${abs}</div>
            </details>
          ` : ``}
          ${url ? `<div style="margin-top:8px; font-size:12.5px;"><a href="${url}" target="_blank" rel="noopener">Read full article →</a></div>` : ``}
        `;

        list.appendChild(card);
      }

      sections.appendChild(list);
    }

    sections.querySelectorAll(".chip.topic").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        const t = chip.getAttribute("data-topic");
        if(!t) return;
        el("topic").value = t;
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });
  }

  // ============================
  // Init controls
  // ============================
  function initControls(){
    const sel = el("journal");
    sel.innerHTML = "";
    for(const j of JOURNALS){
      const opt = document.createElement("option");
      opt.value = j.issn ? j.issn : "__ALL__";
      opt.textContent = j.name;
      sel.appendChild(opt);
    }
    sel.value = "__ALL__";

    const tsel = el("topic");
    tsel.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "__ALL__";
    opt.textContent = "All Topics";
    tsel.appendChild(opt);
    tsel.value = "__ALL__";

    ["q","topic","sort","oaOnly","showAbs","rsOnly"].forEach(id=>{
      el(id).addEventListener("input", ()=> render());
      el(id).addEventListener("change", ()=> render());
    });

    el("journal").addEventListener("change", ()=> loadData());
    el("days").addEventListener("change", ()=> loadData());
    el("reload").addEventListener("click", ()=> loadData());
  }

  initControls();
  loadData().catch(err=>{
    console.error(err);
    setStatus(`Error: ${err.message}`, true);
  });
</script>
</body>
</html>
